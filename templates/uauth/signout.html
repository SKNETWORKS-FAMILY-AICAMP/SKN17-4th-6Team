{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>회원 탈퇴 | Auto FIX</title>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background-color: #F8F9FE;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }

  .logo {
    position: absolute;
    top: 40px;
    left: 90px;
    font-size: 50px;
    font-weight: 700;
    color: #B3BFE9;
    cursor: pointer;
  }

  /* 🔹 로그인 페이지와 동일한 카드 레이아웃 */
  .withdraw-container {
    background-color: #ffffff;
    padding: 50px 40px;
    border-radius: 20px;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.04);
    width: 400px;
    min-height: 500px; /* ✅ 최소 높이 고정 (폰트 줄여도 안정) */
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center; /* 내부 중앙정렬 */
  }

  .withdraw-container h1 {
    font-size: 45px; /* 로그인 제목보다 약간 작게 */
    font-weight: 900;
    color: #55609a;
    margin-bottom: 40px; /* 아래 여백 늘려 균형 맞춤 */
  }

  .withdraw-form {
    width: 100%;
    display: flex;
    flex-direction: column;
  }

  /* 🔹 인풋 스타일 로그인 페이지와 동일 */
  .withdraw-form input[type="password"] {
    width: 100%;
    padding: 16px 18px;
    margin-bottom: 18px;
    border: 1px solid #55609a;
    border-radius: 10px;
    font-size: 15px;
    color: #333;
    outline: none;
    transition: border-color 0.2s ease;
  }

  .withdraw-form input[type="password"]:focus {
    border-color: #9ea2f0;
  }

  .withdraw-form input::placeholder {
    color: #A0A5B4;
    font-size: 15px;
  }

  /* 🔹 피드백 공간 고정 (레이아웃 흔들림 방지) */
  #password-feedback {
    min-height: 18px;
    color: red;
    font-size: 14px;
    margin: 2px 0 10px;
    text-align: left;
  }

  /* 🔹 탈퇴 버튼 */
  .delete-btn {
    width: 50%;
    padding: 10px;
    border: none;
    border-radius: 16px;
    font-size: 16px;
    font-weight: Regular;
    cursor: pointer;
    background: #FF4B4B;
    color: #fff;
    transition: background-color 0.3s ease;
    margin-top: 15px;
    align-self: flex-end;
  }

  .delete-btn:hover {
    background: #e03b3b;
  }

  @media (max-width: 768px) {
    .withdraw-container {
      width: 90%;
      padding: 40px 25px;
    }
    .withdraw-container h1 {
      font-size: 36px;
    }
  }
</style>
</head>

<body>
  <div class="logo" id="logo">&lt;</div>

  <div class="withdraw-container">
    <h1>회원 탈퇴</h1>

    <form class="withdraw-form" id="withdrawForm">
      {% csrf_token %}
      <input type="password" name="password1" id="password1"
             placeholder="비밀번호를 입력해 주세요."
             value="{{ form.password1.value|default:'' }}">
      <input type="password" name="password2" id="password2"
             placeholder="비밀번호 확인"
             value="{{ form.password2.value|default:'' }}">
      <div id="password-feedback"></div>
      <button type="button" class="delete-btn" id="deleteBtn">탈퇴</button>
    </form>
  </div>

  <script>
    document.getElementById("logo").addEventListener("click", () => {
      window.location.href = "{% url 'chat:main' %}";
    });

    document.addEventListener('DOMContentLoaded', () => {
      const pw1 = document.getElementById('password1');
      const pw2 = document.getElementById('password2');
      const feedback = document.getElementById('password-feedback');
      const deleteBtn = document.getElementById('deleteBtn');
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      function updateFeedback() {
        if (pw1.value && pw2.value && pw1.value !== pw2.value) {
          feedback.innerHTML = "비밀번호가 일치하지 않습니다.";
        } else {
          feedback.innerHTML = "";
        }
      }

      pw1.addEventListener('input', updateFeedback);
      pw2.addEventListener('input', updateFeedback);

      deleteBtn.addEventListener('click', async () => {
        if (pw1.value !== pw2.value) {
          alert("비밀번호가 일치하지 않습니다.");
          return;
        }

        if (!confirm("정말로 회원탈퇴 하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) return;

        try {
          const response = await fetch("{% url 'uauth:delete_account' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            body: JSON.stringify({ password: pw1.value }),
          });

          const result = await response.json();

          if (!response.ok) {
            alert(result.message || "회원탈퇴 중 오류가 발생했습니다.");
            return;
          }

          alert(result.message || "회원탈퇴가 완료되었습니다.");
          window.location.href = "/chat/main";
        } catch (err) {
          console.error(err);
          alert("서버 오류가 발생했습니다. 다시 시도해주세요.");
        }
      });
    });
  </script>
</body>
</html>
