{% load static %}

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Auto FIX - 차량 진단 서비스</title>

    <!-- CSS 연결 -->
    <link rel="stylesheet" href="{% static 'css/chat/globals.css' %}">
    <link rel="stylesheet" href="{% static 'css/chat/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/chat/styleguide.css' %}">
  </head>

  <body>
    <div class="div-wrapper">
      <!-- ✅ 왼쪽 사이드바 -->
      <aside class="sidebar" role="complementary">
        <nav class="sidebar-nav" role="navigation" aria-label="메인 네비게이션">
          <div class="logo-container">
            <img
              class="auto-fix-logo"
              src="{% static 'images/chat/auto_fix_logo_chat.png' %}"
              alt="Auto FIX 로고"
            />
          </div>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="{% url 'chat:toggles_page' %}" id="newChatBtn" class="nav-link text-wrapper-2">새 채팅 시작하기</a>
            </li>
            <li class="nav-item">
              <a href="{% url 'chat:main' %}" class="nav-link text-wrapper-3">메인 화면으로 돌아가기</a>
            </li>
          </ul>
          <section class="chat-history-section">
            <h2 class="text-wrapper-4">채팅 히스토리</h2>
          </section>
        </nav>
        <div class="sidebar-footer">
          <a href="javascript:void(0);" id="deleteAccountBtn" class="footer-link text-wrapper-9">회원 탈퇴</a>
          <a href="javascript:void(0);" id="openModalBtn2" class="footer-link text-wrapper-8">비밀번호 수정</a>
          <a href="#profile" class="footer-link text-wrapper-6">회원 정보 수정</a>
          <a href="{% url 'uauth:logout' %}" class="footer-link text-wrapper-5">로그아웃</a>
        </div>
      </aside>

      <!-- ✅ 모달 영역 -->
      <div id="modal" class="modal">
        <div id="modalBody" class="modal-body"></div>
      </div>

      <script>
      document.addEventListener("DOMContentLoaded", function () {
        const modal     = document.getElementById('modal');
        const modalBody = document.getElementById('modalBody');
        const openBtn2  = document.getElementById('openModalBtn2');
        const deleteBtn = document.getElementById('deleteAccountBtn');
      
        // ---- 회원탈퇴 버튼
        if (deleteBtn) {
          deleteBtn.addEventListener('click', function (e) {
            e.preventDefault();
            if (confirm("정말로 회원 탈퇴를 진행하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) {
              window.location.href = "{% url 'uauth:signout' %}";
            }
          });
        } else {
          console.warn('[chat] #deleteAccountBtn not found');
        }
      
        // ---- 비밀번호 수정 모달
        if (openBtn2 && modal && modalBody) {
          openBtn2.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
              // 모달 먼저 열기
              modal.style.display = 'flex';
              modalBody.innerHTML = '<p style="text-align:center;">로딩 중...</p>';
            
              const res = await fetch("{% url 'uauth:reset_password' %}");
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              const html = await res.text();
            
              // XSS 회피 최소 처리
              const safe = html.replace(/"/g, '&quot;');
              modalBody.innerHTML = `<iframe srcdoc="${safe}"></iframe>`;
            } catch (err) {
              console.error('[chat] reset_password load failed:', err);
              modalBody.innerHTML = `<p style="color:red;">불러오기 실패: ${err.message}</p>`;
            }
          });
        
          // 모달 배경 클릭 시 닫기
          modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
          });
        } else {
          console.warn('[chat] modal/openBtn2 not found', { openBtn2, modal, modalBody });
        }
      });
      </script>

      <!-- ✅ 메인 콘텐츠 -->
      <main class="main-content" role="main">
        <header class="page-header">
          <h1 class="page-title">Auto FIX</h1>
          <div class="vehicle-info">
            <span class="text-wrapper-7">차량 정보</span>
            <p class="g-t-GDI">
              {% if vehicle_summary %}{{ vehicle_summary }}{% else %}미선택{% endif %}
            </p>
          </div>
        </header>

        <!-- ✅ 채팅 대화창 -->
        <section id="chat-box" class="chat-box"></section>

        <!-- ✅ 채팅 입력창 -->
        <div class="chat-input-container">
          <form id="chat-form" method="POST" action="{% url 'chat:chat_response' %}">
            {% csrf_token %}
            <input
              type="text"
              id="chat-input"
              name="message"
              class="chat-textarea"
              placeholder="차량의 증상이나 문제를 입력하세요."
              autocomplete="off"
              required
            />
            <button type="submit" class="chat-submit-btn" aria-label="전송">
              <img src="{% static 'images/chat/union.png' %}" alt="" />
            </button>
          </form>
        </div>
      </main>
    </div>

    <!-- ✅ jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- ✅ 채팅 AJAX 스크립트 -->
    <script>
      $(function () {
        $("#chat-form").on("submit", function (e) {
          e.preventDefault();
          const message = $("#chat-input").val().trim();
          if (!message) return;

          // 사용자 메시지 표시
          $("#chat-box").append(
            `<div class="chat-message user"><p>${message}</p></div>`
          );
          $("#chat-input").val("");

          // 자동 스크롤 
          $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);


          // 서버 요청
          $.ajax({
            url: "{% url 'chat:chat_response' %}",
            type: "POST",
            data: {
              message: message,
              csrfmiddlewaretoken: "{{ csrf_token }}",
            },
            success: function (response) {
              $("#chat-box").append(
                `<div class="chat-message bot"><p>${response.response}</p></div>`
              );
              $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);
            },
            error: function () {
              $("#chat-box").append(
                `<div class="chat-message bot error"><p>⚠️ 서버 응답 오류가 발생했습니다.</p></div>`
              );
            },
          });
        });
      });

      // textarea 자동 높이 조절
      function autosize(el){
        el.style.height = 'auto';
        const max = 160; // CSS max-height와 동일
        el.style.height = Math.min(el.scrollHeight, max) + 'px';
      }
    
      document.addEventListener('DOMContentLoaded', () => {
        const ta = document.getElementById('chat-input');
        if (ta){
          autosize(ta);
          ta.addEventListener('input', () => autosize(ta));
        
          // Enter = 전송, Shift+Enter = 줄바꿈
          ta.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey){
              e.preventDefault();
              document.getElementById('chat-form').dispatchEvent(new Event('submit', {cancelable:true}));
            }
          });
        }
      });  
    </script>

    <!--긴급연락|보험 부분-->
    <div id="floatingContainer">
      <div id="infoModal" class="modal">
        <div class="modal-content">
          <button class="close-btn" id="closeModalBtn">&times;</button>
          <div id="infoModalBody" class="modal-body">로딩 중...</div>
        </div>
      </div>
    
      <img id="emergencyIcon" src="{% static 'images/chat/info.png' %}" alt="긴급연락/보험사" />
    </div>
    
    <script>
    document.addEventListener("DOMContentLoaded", function() {
      const modal = document.getElementById('infoModal');
      const modalBody = document.getElementById('infoModalBody');
      const openBtn = document.getElementById('emergencyIcon');
      const closeBtn = document.getElementById('closeModalBtn');
    
      openBtn.addEventListener('click', () => {
        if (modal.style.display === 'block') {
          modal.classList.remove('show');
          setTimeout(() => modal.style.display = 'none', 200);
          return;
        }
      
        modal.style.display = 'block';
        modal.classList.add('show');
      
        fetch("{% url 'chat:info' %}")
          .then(res => {
            console.log('[fetch status]', res.status);
            return res.text();
          })
          .then(html => {
            console.log('[fetch html]', html);
            modalBody.innerHTML = html;
          })
          .catch(err => {
            console.error('[fetch error]', err);
            modalBody.innerHTML = `<p style="color:red;">에러 발생: ${err}</p>`;
          });
      });
    
      closeBtn.addEventListener('click', () => {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 200);
      });
    });
    </script>
  </body>
</html>